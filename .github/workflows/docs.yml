name: Build Website

on:
  push:
    branches:
    - main
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      -
        name: Set up Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      -
        name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcairo2-dev \
            libpango1.0-dev \
            libfreetype6-dev \
            libffi-dev \
            libjpeg-dev \
            libpng-dev \
            zlib1g-dev \
            graphviz \
            libgraphviz-dev
      -
        name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
      -
        name: Install uv
        run: pip install uv
      -
        name: Cache uv dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-
      -
        name: Install all MkDocs dependencies
        run: make --environment-overrides docs-install-github-actions
      -
        name: Build Site
        # Build runs on all branches and PRs to validate changes
        # run 'docs-build' twice because 'gen_files' doesn't let MkDocs 
        # pick up on the generated files in the first run
        run: |
          make --environment-overrides docs-build
          make --environment-overrides docs-build
      -
        name: Deploy Site
        # Deploy only runs on main branch after successful build
        if: ${{ github.ref == 'refs/heads/main' }}
        run: make --environment-overrides docs-deploy
